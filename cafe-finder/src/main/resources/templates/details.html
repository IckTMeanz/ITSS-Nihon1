<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>カフェ詳細 - コーヒーファインダー</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .toast {
            background: #fff;
            color: #333;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid #2ecc71;
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            min-width: 300px;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>

<body style="
    font-family:'Noto Sans JP', sans-serif;
    background:#f2f2f2;
    margin:0;
    padding:20px 0;
">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <div style="
        max-width:1100px;
        background:white;
        margin:0 auto;
        padding:40px;
        border-radius:14px;
        box-shadow:0 4px 16px rgba(0,0,0,0.08);
    ">

        <!-- Header -->
        <h2 th:text='${cafe.name}'
            style="margin:0 0 28px; font-size:32px; font-weight:600;">
            カフェ名
        </h2>

        <!-- Cafe Info -->
        <div style="display:flex; gap:32px; align-items:flex-start;">

            <!-- CAFE IMAGE -->
        <img
            th:src="${#strings.isEmpty(cafe.image) ? '/images/placeholder.png' : (#strings.startsWith(cafe.image, 'http') ? cafe.image : '/images/' + cafe.image)}"
            th:alt="${cafe.name}"
            onerror="this.onerror=null; this.src='/images/placeholder.png';"
            style="
                width:260px;
                height:260px;
                object-fit:cover;
                border-radius:12px;
                box-shadow:0 2px 6px rgba(0,0,0,0.15);
            "
        />

            <div style="font-size:17px; line-height:1.6;">
                <p><i class="fas fa-map-marker-alt" style="color:#c0392b; margin-right:8px;"></i>
                    <span th:text="${cafe.address}">住所</span>
                </p>

                <p><i class="fas fa-star" style="color:#f1c40f; margin-right:8px;"></i>
                   <span th:text="${cafe.rating}">0</span> / 5
                </p>

                <p>
                    <a th:href="@{/map(id=${cafe.id})}" style="display:inline-flex; align-items:center; color:#3498db; text-decoration:none; font-weight:600; transition:0.2s;" onmouseover="this.style.color='#2980b9'" onmouseout="this.style.color='#3498db'">
                        <i class="fas fa-map-marked-alt" style="margin-right:8px; font-size:18px;"></i>
                        地図で見る
                    </a>
                </p>

                <p>
                    ステータス:
                    <span th:text="${cafe.status == 'opening' ? '営業中' : (cafe.status == 'closed' ? '閉店' : '不明')}"></span>
                </p>

                <p th:text="${cafe.description}"
                    style="margin-top:14px;">
                    説明
                </p>
            </div>
        </div>

        <hr style="margin:32px 0;">

        <!-- Menu Section -->
        <h3 style="font-size:26px; margin-bottom:20px;">メニュー</h3>

        <!-- MENU GRID -->
        <div style="
            display:grid;
            grid-template-columns: repeat(3, 1fr);
            gap:28px;
        ">

            <!-- MENU ITEM -->
            <div th:each="dish : ${dishes}"
                style="
                    background:white;
                    padding:18px;
                    border-radius:14px;
                    box-shadow:0 2px 8px rgba(0,0,0,0.08);
                    display:flex;
                    flex-direction:row;
                    gap:16px;
                    min-height:150px;
                    transition:0.2s ease;
                "
                onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.12)'"
                onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)'"
            >
                
                <!-- IMAGE -->
                <img
                th:src="${#strings.isEmpty(dish.image) ? '/images/placeholder.png' : (#strings.startsWith(dish.image, 'http') ? dish.image : '/images/' + dish.image)}"
                onerror="this.onerror=null; this.src='/images/placeholder.png';"
                style="width:85px; height:85px; border-radius:12px; object-fit:cover;"
                />

                <!-- TEXT -->
                <div style="flex:1; display:flex; flex-direction:column;">
                    <div style="margin-bottom:6px;">
                        <strong th:text="${dish.name}"
                            style="font-size:16px; display:block; margin-bottom:4px;">
                            メニュー名
                        </strong>

                        <span th:text="${dish.price}"
                            style="font-size:15px; color:#555;">
                        </span>円
                    </div>

                    <p th:text="${dish.description}"
                        style="
                            margin:4px 0 0;
                            font-size:14px;
                            color:#666;
                            line-height:1.5;
                        ">
                        説明
                    </p>
                </div>
            </div>

            <p th:if="${#lists.isEmpty(dishes)}"
                style="grid-column:1 / span 3; text-align:center; margin-top:10px; color:gray;">
                メニュー情報がありません。
            </p>
        </div>


        <!-- Back button -->
        <div style="text-align:right; margin-top:32px;">
            <a th:href="@{/}"
                style="
                    padding:10px 18px;
                    background:#ddd;
                    border-radius:6px;
                    text-decoration:none;
                    color:#333;
                    font-size:15px;
                "
                onmouseover="this.style.background='#ccc';"
                onmouseout="this.style.background='#ddd';">
                ← 戻る
            </a>
        </div>
        
        <hr style="margin:40px 0;">

        <!-- REVIEW TITLE -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="font-size:26px; margin:0;">レビュー</h3>
            
            <!-- FILTER FORM -->
            <div style="display:flex; align-items:center;">
                <select id="starFilter" name="star" onchange="loadReviews(0)" 
                    style="padding:6px; border-radius:6px; border:1px solid #ccc; font-size:14px;">
                    <option value="">全ての評価</option>
                    <option value="5" th:selected="${param.star != null and param.star[0] == '5'}">★★★★★ (5)</option>
                    <option value="4" th:selected="${param.star != null and param.star[0] == '4'}">★★★★☆ (4)</option>
                    <option value="3" th:selected="${param.star != null and param.star[0] == '3'}">★★★☆☆ (3)</option>
                    <option value="2" th:selected="${param.star != null and param.star[0] == '2'}">★★☆☆☆ (2)</option>
                    <option value="1" th:selected="${param.star != null and param.star[0] == '1'}">★☆☆☆☆ (1)</option>
                </select>
            </div>
        </div>

        <!-- LIST OF REVIEWS -->
        <div id="reviewContainer">
        <div th:fragment="reviewList" style="min-height: 600px; display: flex; flex-direction: column; justify-content: space-between;">
        <div style="display:flex; flex-direction:column; gap:16px;">

            <!-- ONE REVIEW -->
            <div th:each="review : ${reviews}"
                style="
                    background:white;
                    padding:20px;
                    border-radius:12px;
                    border: 1px solid #eee;
                    display: flex;
                    gap: 16px;
                ">
                
                <!-- AVATAR -->
                <div style="
                    width: 48px; height: 48px;
                    background: #e0e0e0;
                    border-radius: 50%;
                    display: flex; align-items: center; justify-content: center;
                    font-weight: bold; color: #555;
                    font-size: 20px;
                    flex-shrink: 0;
                " th:text="${review.userName != null ? #strings.substring(review.userName, 0, 1) : 'U'}">
                    U
                </div>

                <div style="flex: 1;">
                    <div style="display:flex; justify-content:space-between; align-items: flex-start; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight:bold; font-size:16px; color:#333;" th:text="${review.userName}">User</div>
                            <div style="font-size:12px; color:#888;" th:text="${review.createdAt != null ? #temporals.format(review.createdAt, 'yyyy/MM/dd HH:mm') : ''}">Date</div>
                        </div>
                        <div style="color:#f1c40f; font-size:16px;">
                            <span th:each="i : ${#numbers.sequence(1, 5)}">
                                <i th:class="${i <= review.star ? 'fas fa-star' : 'far fa-star'}"></i>
                            </span>
                        </div>
                    </div>
                    
                    <p th:text="${review.content}" style="margin:0; font-size:15px; color:#444; line-height:1.5;"></p>
                </div>
            </div>

            <!-- NO REVIEW -->
            <div th:if="${reviews.isEmpty()}"
                style="text-align:center; color:gray; padding: 40px; background: #f9f9f9; border-radius: 12px;">
                <i class="far fa-comment-dots" style="font-size: 48px; margin-bottom: 16px; color: #ccc;"></i>
                <p>レビューはまだありません。</p>
            </div>

        </div>

        <!-- PAGINATION -->
        <div th:if="${reviews.totalPages > 1}"
             style="display:flex; justify-content:center; gap:8px; margin-top:24px; padding-top: 20px; border-top: 1px solid #eee;">
            
            <!-- Prev -->
            <a th:if="${reviews.hasPrevious()}"
               href="javascript:void(0)"
               th:onclick="'loadReviews(' + ${reviews.number - 1} + ')'"
               style="padding:8px 12px; background:white; border:1px solid #ddd; border-radius:4px; text-decoration:none; color:#333; cursor:pointer;">
               &lt;
            </a>

            <!-- Pages -->
            <th:block th:each="i : ${#numbers.sequence(0, reviews.totalPages - 1)}">
                <a href="javascript:void(0)"
                   th:onclick="'loadReviews(' + ${i} + ')'"
                   th:text="${i + 1}"
                   th:style="${i == reviews.number ? 'background:#3498db; color:white; border-color:#3498db;' : 'background:white; color:#333;'}"
                   style="padding:8px 12px; border:1px solid #ddd; border-radius:4px; text-decoration:none; cursor:pointer;">
                   1
                </a>
            </th:block>

            <!-- Next -->
            <a th:if="${reviews.hasNext()}"
               href="javascript:void(0)"
               th:onclick="'loadReviews(' + ${reviews.number + 1} + ')'"
               style="padding:8px 12px; background:white; border:1px solid #ddd; border-radius:4px; text-decoration:none; color:#333; cursor:pointer;">
               &gt;
            </a>
        </div>
        </div>
        </div>

        <hr style="margin:40px 0;">

        <!-- CREATE REVIEW -->
        <h3 style="font-size:24px; margin-bottom:16px;">レビューを書く</h3>

        <div sec:authorize="!isAuthenticated()"
            style="
                background:#fff3cd;
                padding:16px;
                border-radius:8px;
                color:#856404;
                margin-bottom:20px;
                border:1px solid #ffeaa7;
            ">
            <i class="fas fa-info-circle" style="margin-right:8px;"></i>
            レビューを書くにはログインしてください。
            <a href="/login" style="color:#0066cc; text-decoration:underline; margin-left:8px;">ログインページへ</a>
        </div>

        <form id="reviewForm" sec:authorize="isAuthenticated()"
            style="
                background:white;
                padding:22px;
                border-radius:12px;
                box-shadow:0 2px 8px rgba(0,0,0,0.08);
                display:flex;
                flex-direction:column;
                gap:18px;
            ">

            <!-- USER INFO -->
            <div style="
                background:#e8f4f8;
                padding:12px;
                border-radius:8px;
                border-left:4px solid #3498db;
                margin-bottom:8px;
            ">
                <p style="margin:0; font-size:14px; color:#555;">
                    <strong>投稿者:</strong> 
                    <span sec:authentication="principal.fullName" style="color:#3498db; font-weight:bold;">User</span>
                </p>
            </div>

            <!-- RATING -->
            <div>
                <label style="font-size:15px; font-weight:bold;">評価 (1〜5)</label>
                <select name="star" required
                    style="
                        width:120px; padding:10px;
                        border-radius:6px; border:1px solid #ccc;
                        margin-top:6px; font-size:15px;
                    ">
                    <option value="">選択してください</option>
                    <option value="5">★★★★★ (5)</option>
                    <option value="4">★★★★☆ (4)</option>
                    <option value="3">★★★☆☆ (3)</option>
                    <option value="2">★★☆☆☆ (2)</option>
                    <option value="1">★☆☆☆☆ (1)</option>
                </select>
            </div>

            <!-- COMMENT -->
            <div>
                <label style="font-size:15px; font-weight:bold;">コメント</label>
                <textarea name="content" rows="4" required
                    style="
                        width:100%; padding:10px;
                        border-radius:6px; border:1px solid #ccc;
                        margin-top:6px; font-size:15px;
                        resize:vertical;
                    "></textarea>
            </div>

            <!-- SUBMIT -->
            <button type="submit"
                style="
                    width:160px;
                    padding:12px;
                    background:#3498db;
                    color:white;
                    border:none;
                    border-radius:8px;
                    font-size:16px;
                    cursor:pointer;
                    align-self:flex-end;
                "
                onmouseover="this.style.background='#2980b9'"
                onmouseout="this.style.background='#3498db'">
                投稿する
            </button>

        </form>

    </div>

    <script th:inline="javascript">
        function loadReviews(page) {
            const cafeId = /*[[${cafe.id}]]*/ 0;
            const star = document.getElementById('starFilter').value;
            
            let url = '/cafes/' + cafeId + '/reviews-fragment?page=' + page + '&size=5';
            if (star) url += '&star=' + star;
            
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('reviewContainer').innerHTML = html;
                })
                .catch(error => console.error('Error loading reviews:', error));
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeftColor = type === 'success' ? '#2ecc71' : '#e74c3c';
            
            const icon = type === 'success' ? '<i class="fas fa-check-circle" style="color:#2ecc71"></i>' : '<i class="fas fa-exclamation-circle" style="color:#e74c3c"></i>';
            
            toast.innerHTML = `${icon}<span>${message}</span>`;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        document.getElementById('reviewForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const cafeId = /*[[${cafe.id}]]*/ 0;
            
            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
            
            try {
                const response = await fetch(`/cafes/${cafeId}/reviews`, {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showToast(data.message);
                    form.reset();
                    loadReviews(0); // Reload reviews list
                } else if (response.status === 401) {
                    window.location.href = '/login';
                } else {
                    showToast('エラーが発生しました', 'error');
                }
            } catch (error) {
                console.error(error);
                showToast('エラーが発生しました', 'error');
            }
        });
    </script>
</body>
</html>